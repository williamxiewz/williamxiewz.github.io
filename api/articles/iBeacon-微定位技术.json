{"title":"iBeacon 微定位技术","uid":"00d58d9a73e1bc4a1c001712fc4a5ff9","slug":"iBeacon-微定位技术","date":"2016-08-10T11:01:39.000Z","updated":"2019-05-14T04:53:35.000Z","comments":true,"path":"api/articles/iBeacon-微定位技术.json","keywords":null,"cover":[],"content":"<p>在一家大型商场,医院或是大楼里,你是否会曾经有过找不到想要去的地方的经历呢?<br>这种情况下采用上面介绍的传统定位方式,就有些”力不从心”了,首先不能采用GPS定位,而WiFi 和蜂窝式移动电话基站定位误差比较大,这种情况下的定位就是 “微定位”技术了</p>\n<p>#地理围栏</p>\n<p>微定位技术中一个比较重要的概念—地理围栏. 地理围栏(Geo-fencing)是LBS的一种新应用,就是用一个虚拟的栅栏围出一个虚拟地理边界. 当手机进入,离开某个特定地理区域,或在该区域活动时,手机可以可以接受自动通知和警告.有了地理围栏技术,位置社交网站就可以帮助用户进入某一个地区时自动登记.</p>\n<p>地理围栏可以采用传统定位或微定位实现,当然微定位更加有现实意义,建立地理围栏技术往往是处于电子商务,店内导航和设计活动等目的. 定位环境比较复杂,定位要求比较精确.</p>\n<span id=\"more\"></span>\n<p>#iBeacon 技术</p>\n<p>苹果公司在iOS 7 之后 支持iBeacon技术,iBeacon技术是苹果公司研发的,它使用低功率蓝牙技术,通过多个iBeacon 基站创建一个信号区域(地理围栏),当设备进去该区域时,相应的应用便会提示用户进入这个地理围栏.</p>\n<p>iBeacon 是苹果公司推出的一项室内定位技术，通过软件和硬件的结合，从而大大提高室内精度，从原来的几百米，几十米，提高到一米以内的定位精度。有了这么高精度的定位能力，许多原来只能想一想的事情，现在可以做到了：当你走到某个商品前，手机应用自动跳出商品的介绍，让你的购物体验感，大大增强。下图是一个典型的应用场景：</p>\n<p><img src=\"https://github.com/williamxiewz/williamxie-github-io/raw/master/appledevelopdingweijishuibeacon1.jpg\"></p>\n<p>当用户(安装了特定应用的iOS用户)进入一家大型商场,在门口会有一个iBeacon 基站,它会提示用户是否需要接入这个信号网络。如果用户选择了”是”，他就可以享受到很多服务，iBeacon基站可以核对用户的 Passbook中是否具有本店的某种商品的优惠券或打折卡，当然也可以为用户发放电子优惠<br>打折卡（即pass)，然后存人到passbook中。<br>也可以为用户提供商场的室内导航。最后要结账的时候，iBeacon可以提供零接触支付。</p>\n<p>此外，每个iBeacon基站内置ARM架构cpu、蓝牙模块和闪存，以及加速度计、陀螺仪 寺传愁器。由于采用低功耗蓝牙技术通信，iBeacon基站更加省电，一个小纽扣电池使能为 一个iBeacon基站提供长达两年的续航时间。</p>\n<p>#iBeacon技术实现微定位</p>\n<p>iBeacon技术通信的核心是低功耗蓝牙通信，iBeacon基站就是一个外设，它只是负责广<br>播数据，而中心是用户iOS设备上的应用。我们在开发阶段可以使用一个ios设备，在上<br>面安装一个特定应用使其作为iBeacon基站角色。如果不考虑成本，我们可以使用iOS设<br>备作为iBeacon基站，但事实上这样一个方案过于奢侈了，现在已经有一些公司开发出了功<br>能完善的iBeacon技术的基站，它只需要很低的费用就可以构建iBeacon地理围栏。 </p>\n<p>##iBeacon 基站服务端</p>\n<pre class=\"line-numbers language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">UIKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">CoreBluetooth</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">CoreLocation</span>\n<span class=\"token comment\">// iBeacon UUID</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">kUUID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"88936DF5-E10B-4382-89D6-8AE0D80373F8\"</span>\n<span class=\"token comment\">// 地理围栏区域</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">kID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"com.williamxie.AirLocate\"</span>\n<span class=\"token comment\">// 蓝牙强度</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">kPower</span> <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">59</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">UIViewController</span> <span class=\"token punctuation\">,</span> <span class=\"token builtin\">CBPeripheralManagerDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">//蓝牙低功耗外设管理者</span>\n    <span class=\"token keyword\">var</span> peripheralManager <span class=\"token punctuation\">:</span> <span class=\"token builtin\">CBPeripheralManager</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>peripheralManager <span class=\"token operator\">=</span> <span class=\"token function\">CBPeripheralManager</span><span class=\"token punctuation\">(</span>delegate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> queue<span class=\"token punctuation\">:</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n        \n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token comment\">//广播数据开关</span>\n    <span class=\"token atrule\">@IBAction</span> <span class=\"token keyword\">func</span> <span class=\"token function\">valueChanged</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AnyObject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        \n        <span class=\"token keyword\">let</span> swc <span class=\"token operator\">=</span> sender <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token builtin\">UISwitch</span>\n        <span class=\"token keyword\">if</span> swc<span class=\"token punctuation\">.</span>on <span class=\"token punctuation\">&#123;</span>\n            \n            <span class=\"token keyword\">let</span> uuid <span class=\"token operator\">=</span> <span class=\"token function\">NSUUID</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">UUIDString</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">kUUID</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">//CLBeaconRegion 对象 描述了 基于蓝牙低功耗Beacon 的地理围栏区域</span>\n            <span class=\"token comment\">// 创建iBeancon 基站 定位标示符 和 地理围栏表示</span>\n            <span class=\"token keyword\">let</span> region <span class=\"token operator\">=</span> <span class=\"token function\">CLBeaconRegion</span><span class=\"token punctuation\">(</span>proximityUUID<span class=\"token punctuation\">:</span> uuid<span class=\"token operator\">!</span><span class=\"token punctuation\">,</span> identifier<span class=\"token punctuation\">:</span> <span class=\"token constant\">kID</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">//获取iBeacon 基站广播所需数据</span>\n            <span class=\"token keyword\">let</span> peripheralData <span class=\"token operator\">=</span> region<span class=\"token punctuation\">.</span><span class=\"token function\">peripheralDataWithMeasuredPower</span><span class=\"token punctuation\">(</span><span class=\"token constant\">kPower</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">let</span> dict<span class=\"token punctuation\">:</span><span class=\"token builtin\">NSDictionary</span> <span class=\"token operator\">=</span> peripheralData\n            <span class=\"token comment\">//进行广播</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>peripheralManager<span class=\"token punctuation\">.</span><span class=\"token function\">startAdvertising</span><span class=\"token punctuation\">(</span>dict <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">String</span> <span class=\"token punctuation\">:</span> <span class=\"token builtin\">AnyObject</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span>\n            \n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        \t<span class=\"token comment\">//定制广播</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>peripheralManager<span class=\"token punctuation\">.</span><span class=\"token function\">stopAdvertising</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token comment\">//MARK: --实现CBPeripheralManagerDelegate协议</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function\">peripheralManagerDidUpdateState</span><span class=\"token punctuation\">(</span>peripheral<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CBPeripheralManager</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"外设状态变化\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>##iBeacon 客户端</p>\n<p><code>ViewController.swift</code></p>\n<pre class=\"line-numbers language-swift\" data-language=\"swift\"><code class=\"language-swift\">\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">UIKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">CoreBluetooth</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">CoreLocation</span>\n<span class=\"token comment\">//表示iBeacon 基站</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">kUUID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"88936DF5-E10B-4382-89D6-8AE0D80373F8\"</span>\n<span class=\"token comment\">//表示 地理围栏</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">kID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"com.williamxie.AirLocate\"</span>\n<span class=\"token comment\">//蓝牙强度</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">kPower</span> <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">59</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">UIViewController</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">CLLocationManagerDelegate</span> <span class=\"token punctuation\">&#123;</span>\n    \n    <span class=\"token atrule\">@IBOutlet</span> <span class=\"token keyword\">weak</span> <span class=\"token keyword\">var</span> lblRanging<span class=\"token punctuation\">:</span> <span class=\"token builtin\">UILabel</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">var</span> locationManager <span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLLocationManager</span><span class=\"token operator\">!</span>\n    <span class=\"token comment\">//地理围栏区域</span>\n    <span class=\"token keyword\">var</span> region <span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLBeaconRegion</span><span class=\"token operator\">!</span>\n    \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">viewDidLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager <span class=\"token operator\">=</span> <span class=\"token function\">CLLocationManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span>delegate <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span>\n        \n        <span class=\"token keyword\">let</span> uuid <span class=\"token operator\">=</span> <span class=\"token function\">NSUUID</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">UUIDString</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">kUUID</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>region <span class=\"token operator\">=</span> <span class=\"token function\">CLBeaconRegion</span><span class=\"token punctuation\">(</span>proximityUUID<span class=\"token punctuation\">:</span> uuid<span class=\"token operator\">!</span><span class=\"token punctuation\">,</span> identifier<span class=\"token punctuation\">:</span> <span class=\"token constant\">kID</span><span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span><span class=\"token function\">requestAlwaysAuthorization</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">//view 销毁的时候停止监听和距离检测</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">func</span> <span class=\"token function\">viewDidDisappear</span><span class=\"token punctuation\">(</span>animated<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">viewDidDisappear</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span><span class=\"token function\">stopMonitoringForRegion</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span><span class=\"token function\">stopRangingBeaconsInRegion</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token atrule\">@IBAction</span> <span class=\"token keyword\">func</span> <span class=\"token function\">rangValue</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AnyObject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">let</span> swc <span class=\"token operator\">=</span> sender <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token builtin\">UISwitch</span>\n        <span class=\"token keyword\">if</span> swc<span class=\"token punctuation\">.</span>on <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">//开始检测距离</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span><span class=\"token function\">startRangingBeaconsInRegion</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">//停止检测距离</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span><span class=\"token function\">stopRangingBeaconsInRegion</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    \n    <span class=\"token atrule\">@IBAction</span> <span class=\"token keyword\">func</span> <span class=\"token function\">onClickMonitoring</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AnyObject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">//开始检测范围</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>locationManager<span class=\"token punctuation\">.</span><span class=\"token function\">startMonitoringForRegion</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    \n    <span class=\"token comment\">//MARK: --实现CLLocationManagerDelegate委托协议</span>\n    <span class=\"token comment\">//范围状态变化时候调用</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function\">locationManager</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLLocationManager</span><span class=\"token punctuation\">,</span> didDetermineState state<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLRegionState</span><span class=\"token punctuation\">,</span> forRegion region<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLRegion</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">let</span> notification <span class=\"token operator\">=</span> <span class=\"token function\">UILocalNotification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">//判断是在围栏外还是围栏内</span>\n        <span class=\"token keyword\">if</span> state <span class=\"token operator\">==</span> <span class=\"token punctuation\">.</span><span class=\"token builtin\">Inside</span> <span class=\"token punctuation\">&#123;</span>\n            notification<span class=\"token punctuation\">.</span>alertBody <span class=\"token operator\">=</span> <span class=\"token string\">\"你在围栏内\"</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> state <span class=\"token operator\">==</span> <span class=\"token punctuation\">.</span><span class=\"token builtin\">Outside</span> <span class=\"token punctuation\">&#123;</span>\n            notification<span class=\"token punctuation\">.</span>alertBody <span class=\"token operator\">=</span> <span class=\"token string\">\"你在围栏外\"</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token comment\">//发送本地通知</span>\n        <span class=\"token builtin\">UIApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">sharedApplication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">presentLocalNotificationNow</span><span class=\"token punctuation\">(</span>notification<span class=\"token punctuation\">)</span>\n     <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">//在设备将要进入到指定的地理围栏内时候调用</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function\">locationManager</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLLocationManager</span><span class=\"token punctuation\">,</span> didEnterRegion region<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLRegion</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">let</span> notification <span class=\"token operator\">=</span> <span class=\"token function\">UILocalNotification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        notification<span class=\"token punctuation\">.</span>alertBody <span class=\"token operator\">=</span> <span class=\"token string\">\"你进入围栏\"</span>\n        <span class=\"token builtin\">UIApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">sharedApplication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">presentLocalNotificationNow</span><span class=\"token punctuation\">(</span>notification<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">//在设备将要退出到指定的地理围栏内时候调用</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function\">locationManager</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLLocationManager</span><span class=\"token punctuation\">,</span> didExitRegion region<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLRegion</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">let</span> notification <span class=\"token operator\">=</span> <span class=\"token function\">UILocalNotification</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        notification<span class=\"token punctuation\">.</span>alertBody <span class=\"token operator\">=</span> <span class=\"token string\">\"你退出围栏\"</span>\n        <span class=\"token builtin\">UIApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">sharedApplication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">presentLocalNotificationNow</span><span class=\"token punctuation\">(</span>notification<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">//在指定的围栏中Beacon设备位置变化时调用, beacons是多个beacon设备的数组</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function\">locationManager</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLLocationManager</span><span class=\"token punctuation\">,</span> didRangeBeacons beacons<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">CLBeacon</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> inRegion region<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLBeaconRegion</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n       \n        <span class=\"token keyword\">let</span> aryBeacons <span class=\"token operator\">=</span> beacons <span class=\"token keyword\">as</span> <span class=\"token builtin\">NSArray</span>\n        <span class=\"token comment\">//逻辑查询条件对象,用来在内存中过滤集合对象,通过格式化Predicate字符串创建NSPredicate</span>\n        <span class=\"token keyword\">var</span> predicate <span class=\"token operator\">=</span> <span class=\"token function\">NSPredicate</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">:</span> <span class=\"token string\">\"proximity = %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">CLProximity</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">Unknown</span><span class=\"token punctuation\">.</span>rawValue<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> unknownBeacons <span class=\"token operator\">=</span> aryBeacons<span class=\"token punctuation\">.</span><span class=\"token function\">filteredArrayUsingPredicate</span><span class=\"token punctuation\">(</span>predicate<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> unknownBeacons<span class=\"token punctuation\">.</span><span class=\"token builtin\">count</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>lblRanging<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token string\">\"未检测到\"</span>\n        <span class=\"token punctuation\">&#125;</span>\n        \n        predicate <span class=\"token operator\">=</span> <span class=\"token function\">NSPredicate</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">:</span> <span class=\"token string\">\"proximity = %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">CLProximity</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">Immediate</span><span class=\"token punctuation\">.</span>rawValue<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> immediateBeacons <span class=\"token operator\">=</span> aryBeacons<span class=\"token punctuation\">.</span><span class=\"token function\">filteredArrayUsingPredicate</span><span class=\"token punctuation\">(</span>predicate<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> immediateBeacons<span class=\"token punctuation\">.</span><span class=\"token builtin\">count</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>lblRanging<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token string\">\"最接近\"</span>\n        <span class=\"token punctuation\">&#125;</span>\n        \n        predicate <span class=\"token operator\">=</span> <span class=\"token function\">NSPredicate</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">:</span> <span class=\"token string\">\"proximity = %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">CLProximity</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">Near</span><span class=\"token punctuation\">.</span>rawValue<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> nearBeacons <span class=\"token operator\">=</span> aryBeacons<span class=\"token punctuation\">.</span><span class=\"token function\">filteredArrayUsingPredicate</span><span class=\"token punctuation\">(</span>predicate<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> nearBeacons<span class=\"token punctuation\">.</span><span class=\"token builtin\">count</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>lblRanging<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token string\">\"近距离\"</span>\n        <span class=\"token punctuation\">&#125;</span>\n        \n        predicate <span class=\"token operator\">=</span> <span class=\"token function\">NSPredicate</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">:</span> <span class=\"token string\">\"proximity = %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">CLProximity</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">Far</span><span class=\"token punctuation\">.</span>rawValue<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> farBeacons <span class=\"token operator\">=</span> aryBeacons<span class=\"token punctuation\">.</span><span class=\"token function\">filteredArrayUsingPredicate</span><span class=\"token punctuation\">(</span>predicate<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> farBeacons<span class=\"token punctuation\">.</span><span class=\"token builtin\">count</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>lblRanging<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token string\">\"远距离\"</span>\n        <span class=\"token punctuation\">&#125;</span>\n        \n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n要用到通知<span class=\"token punctuation\">,</span>所以配置通知的环境 在<span class=\"token builtin\">Info</span><span class=\"token punctuation\">.</span>plist 添加字段\n\n`<span class=\"token builtin\">AppDelegate</span><span class=\"token punctuation\">.</span>swift`\n```swift\n    <span class=\"token keyword\">func</span> <span class=\"token function\">application</span><span class=\"token punctuation\">(</span>application<span class=\"token punctuation\">:</span> <span class=\"token builtin\">UIApplication</span><span class=\"token punctuation\">,</span> didFinishLaunchingWithOptions launchOptions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">NSObject</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">AnyObject</span><span class=\"token punctuation\">]</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Bool</span> <span class=\"token punctuation\">&#123;</span>\n        \n        <span class=\"token keyword\">let</span> setting <span class=\"token operator\">=</span> <span class=\"token function\">UIUserNotificationSettings</span><span class=\"token punctuation\">(</span>forTypes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">Alert</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token builtin\">Badge</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token builtin\">Sound</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> categories<span class=\"token punctuation\">:</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n        <span class=\"token builtin\">UIApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">sharedApplication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">registerUserNotificationSettings</span><span class=\"token punctuation\">(</span>setting<span class=\"token punctuation\">)</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n<p>参考:</p>\n<p><code>CLBeaconRegion</code> 类</p>\n<pre class=\"line-numbers language-swift\" data-language=\"swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CLBeaconRegion</span> <span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLRegion</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">//identifier 是用来表示地理围栏的</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>proximityUUID<span class=\"token punctuation\">:</span> <span class=\"token constant\">NSUUID</span><span class=\"token punctuation\">,</span> identifier<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>proximityUUID<span class=\"token punctuation\">:</span> <span class=\"token constant\">NSUUID</span><span class=\"token punctuation\">,</span> major<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLBeaconMajorValue</span><span class=\"token punctuation\">,</span> identifier<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>proximityUUID<span class=\"token punctuation\">:</span> <span class=\"token constant\">NSUUID</span><span class=\"token punctuation\">,</span> major<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLBeaconMajorValue</span><span class=\"token punctuation\">,</span> minor<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CLBeaconMinorValue</span><span class=\"token punctuation\">,</span> identifier<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function\">peripheralDataWithMeasuredPower</span><span class=\"token punctuation\">(</span>measuredPower<span class=\"token punctuation\">:</span> <span class=\"token builtin\">NSNumber</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">NSMutableDictionary</span>\n\n  \t<span class=\"token comment\">/// 接近UUID 一个128的唯一表示,表示一个或多个iBeacon基站 </span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">var</span> proximityUUID<span class=\"token punctuation\">:</span> <span class=\"token constant\">NSUUID</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 主值 它是一个16位的无符号整数，用于区分有相同的接近UUID的 iBeacon基站</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">var</span> major<span class=\"token punctuation\">:</span> <span class=\"token builtin\">NSNumber</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 副值  它是一个16位的无符号整数，用于区分有相同的接近UUID和的主值的iBeacon基站 </span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">var</span> minor<span class=\"token punctuation\">:</span> <span class=\"token builtin\">NSNumber</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">//</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">var</span> notifyEntryStateOnDisplay<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Bool</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","text":"在一家大型商场,医院或是大楼里,你是否会曾经有过找不到想要去的地方的经历呢?这种情况下采用上面介绍的传统定位方式,就有些”力不从心”了,首先不能采用GPS定位,而WiFi 和蜂窝式移动电话基站定位误差比较大,这种情况下的定位就是 “微定位”技术了 #地理围栏 微定位技术中一个比较...","link":"","photos":[],"count_time":{"symbolsCount":"8.2k","symbolsTime":"7 mins."},"categories":[{"name":"iOS SDK","slug":"iOS-SDK","count":18,"path":"api/categories/iOS-SDK.json"}],"tags":[{"name":"iBeacon","slug":"iBeacon","count":1,"path":"api/tags/iBeacon.json"}],"toc":"","author":{"name":"William Xie","slug":"blog-author","avatar":"/img/author.png","link":"/","description":"","socials":{"github":"https://github.com/williamxiewz","twitter":"https://twitter.com/williamxie_wz","stackoverflow":"http://stackoverflow.com/users/4078104/goingxiebin-jobs","wechat":"","qq":"","weibo":"https://weibo.com/u/2281381063","zhihu":"https://www.zhihu.com/people/williamxiewz","csdn":"https://blog.csdn.net/u014222645","juejin":"https://juejin.cn/user/3280598430133277","customs":{}}},"mapped":true,"prev_post":{"title":"Wallet 开发","uid":"9f6ced9582899d9cc298fd7b7b36a194","slug":"Wallet开发","date":"2016-08-10T11:08:30.000Z","updated":"2016-08-22T15:37:25.000Z","comments":true,"path":"api/articles/Wallet开发.json","keywords":null,"cover":null,"text":"2012年WWDC上iOS6发布了一个全新的应用–Passbook，管理电子票券，包括登机牌，电影票，优惠卡，购物卡等。2015年苹果全球开发者大会(WWDC 2015)在美国旧金山正式开幕本届主题为“the epicenter of change.（变革的中心）”。苹果在会上宣...","link":"","photos":[],"count_time":{"symbolsCount":242,"symbolsTime":"1 mins."},"categories":[{"name":"iOS SDK","slug":"iOS-SDK","count":18,"path":"api/categories/iOS-SDK.json"}],"tags":[{"name":"Wallet","slug":"Wallet","count":1,"path":"api/tags/Wallet.json"}],"author":{"name":"William Xie","slug":"blog-author","avatar":"/img/author.png","link":"/","description":"","socials":{"github":"https://github.com/williamxiewz","twitter":"https://twitter.com/williamxie_wz","stackoverflow":"http://stackoverflow.com/users/4078104/goingxiebin-jobs","wechat":"","qq":"","weibo":"https://weibo.com/u/2281381063","zhihu":"https://www.zhihu.com/people/williamxiewz","csdn":"https://blog.csdn.net/u014222645","juejin":"https://juejin.cn/user/3280598430133277","customs":{}}}},"next_post":{"title":"Multipeer connectivity 对等结构网络编程","uid":"89f1cad59352c7f82ca21656f76e183c","slug":"Multipeer-connectivity-对等结构网络编程","date":"2016-08-10T10:58:32.000Z","updated":"2016-08-22T15:37:47.000Z","comments":true,"path":"api/articles/Multipeer-connectivity-对等结构网络编程.json","keywords":null,"cover":null,"text":"#对等结构网络 对等结构网络是苹果的Ad Hoc网络的一种,是在小空间里构建无限网络的解决方案。苹果公司的GameKit或Multipeer Connectivity(多点连接）框架中提供了开发这种网络的APi. 在iOS7中，引入了一个全新的框架——Multipeer Conn...","link":"","photos":[],"count_time":{"symbolsCount":"8.1k","symbolsTime":"7 mins."},"categories":[{"name":"iOS网络编程","slug":"iOS网络编程","count":9,"path":"api/categories/iOS网络编程.json"}],"tags":[{"name":"Multipeer connectivity","slug":"Multipeer-connectivity","count":1,"path":"api/tags/Multipeer-connectivity.json"}],"author":{"name":"William Xie","slug":"blog-author","avatar":"/img/author.png","link":"/","description":"","socials":{"github":"https://github.com/williamxiewz","twitter":"https://twitter.com/williamxie_wz","stackoverflow":"http://stackoverflow.com/users/4078104/goingxiebin-jobs","wechat":"","qq":"","weibo":"https://weibo.com/u/2281381063","zhihu":"https://www.zhihu.com/people/williamxiewz","csdn":"https://blog.csdn.net/u014222645","juejin":"https://juejin.cn/user/3280598430133277","customs":{}}}}}